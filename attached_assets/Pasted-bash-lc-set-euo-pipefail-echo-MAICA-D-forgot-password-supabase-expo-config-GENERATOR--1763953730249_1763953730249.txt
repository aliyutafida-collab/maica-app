bash -lc 'set -euo pipefail
echo "=== MAICA: D (forgot-password + supabase + expo config) GENERATOR START ==="

# create folder structure
mkdir -p backend/src/routes backend/src/utils backend/migrations mobile/src/auth mobile/src/utils mobile/src/i18n assets eas-config;

#### BACKEND: package.json (if missing)
if [ ! -f backend/package.json ]; then
  cat > backend/package.json <<'"JSON"'
{
  "name": "maica-backend",
  "version": "1.0.0",
  "main": "src/index.js",
  "license": "MIT",
  "scripts": {
    "start": "node src/index.js",
    "dev": "nodemon src/index.js",
    "migrate": "echo \"Run your DB migrations manually\""
  },
  "dependencies": {
    "express": "^4.18.2",
    "bcrypt": "^5.1.0",
    "uuid": "^9.0.0",
    "pg": "^8.11.0",
    "nodemailer": "^6.9.3",
    "@supabase/supabase-js": "^2.10.0",
    "jsonwebtoken": "^9.0.0"
  },
  "devDependencies": {
    "nodemon": "^2.0.22"
  }
}
JSON
  echo "Created backend/package.json"
fi

#### BACKEND: basic server entry
cat > backend/src/index.js <<'"JS"'
const express = require('express');
const bodyParser = require('body-parser');
const authRoutes = require('./routes/auth');
const productsRoutes = require('./routes/products') || require('./routes/products.fixed');
const app = express();
app.use(bodyParser.json());
app.use('/auth', authRoutes);
app.use('/products', productsRoutes);
const PORT = process.env.PORT || 4000;
app.listen(PORT, ()=> console.log(`MAICA backend listening on ${PORT}`));
JS

#### BACKEND: supabase client helper
cat > backend/src/utils/supabaseClient.js <<'"JS"'
const { createClient } = require('@supabase/supabase-js');
const SUPABASE_URL = process.env.SUPABASE_URL || '';
const SUPABASE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.SUPABASE_KEY || '';
if (!SUPABASE_URL || !SUPABASE_KEY) {
  console.warn('Warning: SUPABASE_URL or SUPABASE_KEY not set in env');
}
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
module.exports = supabase;
JS

#### BACKEND: email util (nodemailer)
cat > backend/src/utils/email.js <<'"JS"'
const nodemailer = require('nodemailer');

function createTransport() {
  if (!process.env.SMTP_HOST) {
    console.warn('SMTP not configured - emails will fail until env vars are set.');
  }
  return nodemailer.createTransport({
    host: process.env.SMTP_HOST || 'smtp.example.com',
    port: Number(process.env.SMTP_PORT || 587),
    secure: (process.env.SMTP_SECURE === "true") || false,
    auth: {
      user: process.env.SMTP_USER || '',
      pass: process.env.SMTP_PASS || ''
    }
  });
}

async function sendResetEmail(to, resetLink) {
  const transporter = createTransport();
  const info = await transporter.sendMail({
    from: process.env.EMAIL_FROM || '"Maica" <no-reply@maica.app>',
    to,
    subject: "Maica password reset",
    text: `Reset your password using this link: ${resetLink}`,
    html: `<p>Reset your password using this link:</p><p><a href="${resetLink}">${resetLink}</a></p>`
  });
  return info;
}

module.exports = { sendResetEmail };
JS

#### BACKEND: auth routes (register, login, forgot, reset, logout)
cat > backend/src/routes/auth.js <<'"JS"'
const express = require('express');
const router = express.Router();
const crypto = require('crypto');
const bcrypt = require('bcrypt');
const { v4: uuidv4 } = require('uuid');
const db = require('../../db') || require('../../dbstub');
const { sendResetEmail } = require('../utils/email');

// NOTE: db is expected to export query(text, params) for Postgres or equivalent.
// If using Supabase, you can replace db calls with supabase.from(...)

const RESET_TOKEN_EXPIRY_MINUTES = Number(process.env.RESET_TOKEN_EXPIRY_MINUTES || 60);

router.post('/register', async (req,res)=>{
  const { email, password, firstName, lastName } = req.body;
  // Server-side strong password enforcement
  const strongPasswordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[\\W_]).{10,}$/;
  if (!strongPasswordRegex.test(password)) {
    return res.status(400).json({ error: 'Password must be at least 10 chars and include upper, lower, number, symbol.'});
  }
  const password_hash = await bcrypt.hash(password, 12);
  // Adapt this SQL to your DB schema; using parameterized queries
  const id = uuidv4();
  await db.query('INSERT INTO users (id, email, password_hash, first_name, last_name, provider, created_at) VALUES ($1,$2,$3,$4,$5,$6,NOW())', [id, email, password_hash, firstName||null, lastName||null, 'local']);
  res.json({ ok: true, id });
});

router.post('/login', async (req,res)=>{
  const { email, password } = req.body;
  const userRes = await db.query('SELECT id,password_hash,email_verified FROM users WHERE email=$1', [email]);
  if (!userRes || !userRes.rows || userRes.rows.length===0) return res.status(400).json({ error: 'Invalid credentials' });
  const user = userRes.rows[0];
  const ok = await bcrypt.compare(password, user.password_hash);
  if (!ok) return res.status(400).json({ error: 'Invalid credentials' });
  // Issue JWT or let Supabase handle. Placeholder:
  const token = crypto.randomBytes(24).toString('hex');
  // store token in refresh store if required
  res.json({ ok: true, token, userId: user.id });
});

router.post('/forgot', async (req,res)=>{
  const { email } = req.body;
  // Always return 200 to avoid leaking whether email exists
  try {
    const userRes = await db.query('SELECT id FROM users WHERE email=$1', [email]);
    if (userRes.rows.length===0) return res.json({ ok: true }); // do not reveal existence
    const user = userRes.rows[0];
    const rawToken = crypto.randomBytes(32).toString('hex');
    const tokenHash = crypto.createHash('sha256').update(rawToken).digest('hex');
    const expiresAt = new Date(Date.now() + RESET_TOKEN_EXPIRY_MINUTES*60*1000).toISOString();
    await db.query('INSERT INTO password_resets (id,user_id,token_hash,expires_at,created_at) VALUES ($1,$2,$3,$4,NOW())', [uuidv4(), user.id, tokenHash, expiresAt]);
    // Build deep link or web URL â€” mobile should handle deep link
    const resetLink = (process.env.MAICA_WEB_URL || "https://maica.app") + `/reset-password?token=${rawToken}&email=${encodeURIComponent(email)}`;
    await sendResetEmail(email, resetLink);
  } catch (e) {
    console.error("forgot error", e);
  }
  res.json({ ok: true });
});

router.post('/reset', async (req,res)=>{
  const { token, password, email } = req.body;
  if (!token || !password) return res.status(400).json({ error: "Missing token or password" });
  const tokenHash = crypto.createHash('sha256').update(token).digest('hex');
  const row = await db.query('SELECT id,user_id,expires_at FROM password_resets WHERE token_hash=$1', [tokenHash]);
  if (!row || row.rows.length===0) return res.status(400).json({ error: "Invalid or expired token" });
  const reset = row.rows[0];
  if (new Date(reset.expires_at) < new Date()) return res.status(400).json({ error: "Token expired" });
  // update password
  const password_hash = await bcrypt.hash(password, 12);
  await db.query('UPDATE users SET password_hash=$1 WHERE id=$2', [password_hash, reset.user_id]);
  // delete or mark token used
  await db.query('DELETE FROM password_resets WHERE id=$1', [reset.id]);
  // Optionally revoke sessions / refresh tokens
  res.json({ ok: true });
});

// Logout stub: revoke refresh token (if implemented)
router.post('/logout', async (req,res)=>{
  // Implement refresh token revocation or supabase sign-out if using that
  res.json({ ok: true });
});

module.exports = router;
JS

#### BACKEND: DB migration stubs (users + password_resets)
cat > backend/migrations/$(date +%Y%m%d%H%M%S)_users_and_password_resets.sql <<'"SQL"'
-- Users and password_resets migration stub (Postgres)
CREATE TABLE IF NOT EXISTS users (
  id UUID PRIMARY KEY,
  email TEXT UNIQUE,
  password_hash TEXT,
  first_name TEXT,
  last_name TEXT,
  provider TEXT DEFAULT 'local',
  push_tokens JSONB DEFAULT '[]'::jsonb,
  email_verified BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS password_resets (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  token_hash TEXT NOT NULL,
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
CREATE INDEX IF NOT EXISTS idx_password_resets_token ON password_resets(token_hash);
SQL

#### BACKEND: products fixed (if missing)
if [ ! -f backend/src/routes/products.fixed.js ]; then
  cat > backend/src/routes/products.fixed.js <<'"JS"'
const express = require('express');
const router = express.Router();
const db = require('../../db') || require('../../dbstub');

router.get('/', async (req,res)=>{
  const page = Number(req.query.page || 0);
  const perPage = Math.min(Number(req.query.perPage || 20), 100);
  const offset = page * perPage;
  const result = await db.query('SELECT id,name,price,qty,image_url FROM products ORDER BY created_at DESC LIMIT $1 OFFSET $2', [perPage, offset]);
  res.json({ data: result.rows, page, perPage });
});

module.exports = router;
JS
fi

#### BACKEND: db stub (if user doesn't have db helper)
if [ ! -f backend/db.js ]; then
  cat > backend/db.js <<'"JS"'
/**
 * DB stub - replace with your real Postgres client or Supabase queries.
 * Example: const { Pool } = require('pg'); const pool = new Pool({ connectionString: process.env.DATABASE_URL });
 */
module.exports = {
  query: async (text, params) => {
    console.log("DB stub query:", text, params);
    return { rows: [] };
  }
};
JS
fi

#### MOBILE: package.json additions (if missing)
if [ ! -f mobile/package.json ]; then
  cat > mobile/package.json <<'"JSON"'
{
  "name": "maica-mobile",
  "private": true,
  "main": "node_modules/expo/AppEntry.js",
  "dependencies": {
    "expo": "^49.0.0",
    "expo-linking": "^5.0.0",
    "expo-secure-store": "^12.0.0",
    "@react-native-async-storage/async-storage": "^1.20.0",
    "@supabase/supabase-js": "^2.10.0",
    "react": "18.2.0",
    "react-native": "0.72.0"
  },
  "scripts": {
    "start": "expo start",
    "android": "expo run:android",
    "ios": "expo run:ios"
  }
}
JSON
  echo "Created mobile/package.json"
fi

#### MOBILE: supabase helper for client
cat > mobile/src/utils/supabaseClient.js <<'"JS"'
import { createClient } from '@supabase/supabase-js';
const SUPABASE_URL = process.env.SUPABASE_URL || (typeof global !== "undefined" && global.__SUPABASE_URL__) || '';
const SUPABASE_KEY = process.env.SUPABASE_ANON_KEY || (typeof global !== "undefined" && global.__SUPABASE_ANON_KEY__) || '';
if (!SUPABASE_URL || !SUPABASE_KEY) console.warn("Warning: SUPABASE_URL or SUPABASE_ANON_KEY missing");
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY, { auth: { persistSession: false }});
export default supabase;
JS

#### MOBILE: forgot password UI stub (sends to backend)
cat > mobile/src/auth/forgotPassword.js <<'"JS"'
import React, { useState } from "react";
import { View, TextInput, Button, Text } from "react-native";
import api from "../utils/api";

export default function ForgotPassword({ navigation }) {
  const [email, setEmail] = useState("");
  const [sent, setSent] = useState(false);
  const onSend = async () => {
    await api.post("/auth/forgot", { email }).catch(()=>{});
    setSent(true);
  };
  if (sent) return <View style={{padding:20}}><Text>Check your email (if registered). Follow the link to reset.</Text></View>;
  return (
    <View style={{padding:20}}>
      <Text>Enter email to receive reset link</Text>
      <TextInput value={email} onChangeText={setEmail} keyboardType="email-address" autoCapitalize="none" style={{borderWidth:1,padding:8,marginVertical:8}} />
      <Button title="Send reset link" onPress={onSend} />
    </View>
  );
}
JS

#### MOBILE: reset password UI stub (reads token via deep link or param)
cat > mobile/src/auth/resetPassword.js <<'"JS"'
import React, { useState, useEffect } from "react";
import { View, TextInput, Button, Text } from "react-native";
import * as Linking from "expo-linking";
import api from "../utils/api";

export default function ResetPassword({ route, navigation }) {
  const [token, setToken] = useState(route?.params?.token || "");
  const [email, setEmail] = useState(route?.params?.email || "");
  const [password, setPassword] = useState("");

  useEffect(()=> {
    // handle deep link open when app launched via link
    const subscription = Linking.addEventListener("url", ({ url }) => {
      const parsed = Linking.parse(url);
      if (parsed.queryParams?.token) {
        setToken(parsed.queryParams.token);
        if (parsed.queryParams.email) setEmail(parsed.queryParams.email);
      }
    });
    return ()=> subscription.remove();
  },[]);

  const onReset = async () => {
    await api.post("/auth/reset", { token, password, email }).then(()=> {
      navigation.reset({ index:0, routes:[{ name: "Login" }]});
    }).catch(()=> alert("Reset failed"));
  };

  return (
    <View style={{padding:20}}>
      <Text>Enter new password</Text>
      <TextInput value={password} onChangeText={setPassword} secureTextEntry style={{borderWidth:1,padding:8,marginVertical:8}} />
      <Button title="Set new password" onPress={onReset} />
    </View>
  );
}
JS

#### MOBILE: simple api wrapper
cat > mobile/src/utils/api.js <<'"JS"'
import Constants from "expo-constants";
const API_BASE = Constants.manifest?.extra?.apiUrl || process.env.API_URL || "http://localhost:4000";
async function request(path, opts = {}) {
  const url = API_BASE + path;
  const res = await fetch(url, {...opts, headers: {...opts.headers, "content-type":"application/json"}} );
  return res.json();
}
export default {
  post: (path, body) => request(path, { method: "POST", body: JSON.stringify(body) }),
  get: (path) => request(path, { method: "GET" })
};
JS

#### EXPO / EAS: app.json + eas.json (deep link placeholders)
cat > app.json <<'"JSON"'
{
  "expo": {
    "name": "Maica",
    "slug": "maica",
    "version": "1.0.0",
    "orientation": "portrait",
    "platforms": ["ios","android"],
    "scheme": "maica",
    "extra": {
      "apiUrl": "https://api.maica.app"
    },
    "ios": {
      "bundleIdentifier": "com.zanikon.maica",
      "supportsTablet": true,
      "associatedDomains": ["applinks:maica.app"] 
    },
    "android": {
      "package": "com.zanikon.maica",
      "intentFilters": [
        {
          "action": "VIEW",
          "data": [{ "scheme": "https", "host": "maica.app", "pathPrefix": "/reset-password" }],
          "category": ["BROWSABLE","DEFAULT"]
        }
      ]
    }
  }
}
JSON

cat > eas.json <<'"JSON"'
{
  "build": {
    "production": {
      "android": {
        "buildType": "app-bundle"
      },
      "ios": {
        "simulator": false
      }
    }
  },
  "submit": {
    "production": {}
  }
}
JSON

#### PLACEHOLDER: README with env vars and next steps
cat > MAICA_SETUP_NOTES.txt <<'"TEXT"'
MAICA Setup - Next Steps & ENV VARS

1) Set these environment variables (Replit secrets or server env):
   - SUPABASE_URL
   - SUPABASE_KEY (service role for server-side operations)
   - SUPABASE_ANON_KEY (for mobile)
   - DATABASE_URL (Postgres, if using local DB)
   - SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, EMAIL_FROM
   - MAICA_WEB_URL (e.g., https://maica.app) and API_URL for mobile
   - EXPO_PUBLIC_URL / EAS envs for EAS build
   - JWT_SECRET (if issuing JWTs yourself)
   - FCM_SERVER_KEY or EXPO_PUSH_KEY if using push

2) Install dependencies:
   - backend: cd backend && npm install
   - mobile: cd mobile && npm install

3) Run DB migrations (use backend/migrations/*.sql with psql or your DB tool).
   - Example: psql $DATABASE_URL -f backend/migrations/$(ls backend/migrations | tail -n1)

4) Configure Supabase (recommended):
   - Use Supabase Auth for sign-in providers, or continue using local auth above.
   - If using Supabase, replace backend/db.js queries with supabase.from(...) calls.

5) Test flows locally:
   - Start backend: cd backend && npm run dev
   - Start mobile: cd mobile && expo start
   - Test /auth/forgot and /auth/reset with real SMTP credentials.

6) Expo/EAS:
   - Install eas-cli, login, configure credentials, then build:
     - expo install eas-cli
     - eas build --platform android
     - eas build --platform ios

7) Review code and secure secrets before deploying to production.
TEXT

#### FINISH
echo "====================================="
echo "MAICA SETUP FILES CREATED."
echo "Files created in: backend/, mobile/, app.json, eas.json"
echo "Read MAICA_SETUP_NOTES.txt for required env vars & next steps."
echo "Run 'cd backend && npm install' and 'cd mobile && npm install' to install dependencies."
echo "After deps install: run migrations, set env vars, then test auth & forgot/reset flow."
echo "When ready to build: configure Expo/EAS and follow EAS build steps in README."
echo "====================================="
echo "=== MAICA: GENERATOR FINISHED ==="
'